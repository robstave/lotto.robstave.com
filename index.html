<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>California SuperLotto VibeCode Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
      :root {
        --cat-size: 240px;
      }
      body {
        font-family: Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        background: linear-gradient(#22004c, #3f007f);
        color: #e9d7ff;
      }
      .container {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(48, 25, 71, 0.95);
        border-radius: 16px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        padding: 24px;
        max-width: 500px;
        overflow: hidden;
        color: #e9d7ff;
      }
      .cat-wrapper {
        position: relative;
        width: var(--cat-size);
        height: var(--cat-size);
        margin-bottom: 24px;
      }
      .cat-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }
      h2 {
        margin: 0;
        color: #f0e8ff;
      }
      p {
        margin-top: 8px;
        margin-bottom: 16px;
        color: #d1b6f2;
        text-align: center;
      }
      .button {
        margin-top: 12px;
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        background: #7e56da;
        color: #ffffff;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
      }
      .button:hover {
        background: #916ce0;
      }
      .button.secondary {
        background: #5440a3;
      }
      .button.secondary:hover {
        background: #6654b8;
      }
      .button-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
        width: 100%;
      }
      .button-row .button {
        margin-top: 0;
      }
      @media (min-width: 480px) {
        .button-row {
          flex-direction: row;
          justify-content: center;
        }
        .button-row .button {
          flex: 1;
        }
      }
      .numbers {
        margin-top: 24px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        /* Prevent the container from collapsing when numbers are temporarily removed */
        min-height: 60px;
      }
      .board {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        display: none;
      }
      .number-ball {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 20px;
        color: #ffffff;
        background: #7e56da;
        animation: bounce 0.6s ease-out;
      }
      .mega-ball {
        background: #bb65c8;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-12px);
        }
        60% {
          transform: translateY(-6px);
        }
      }
      /* Sparkles */
      #sparkle-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
      }
      .sparkle {
        position: absolute;
        background: #bb86fc;
        opacity: 0;
        transform: rotate(45deg) scale(0);
        border-radius: 2px;
        animation: sparkle 1.5s ease-out forwards;
      }
      @keyframes sparkle {
        0% {
          opacity: 1;
          transform: rotate(45deg) scale(0);
        }
        50% {
          opacity: 1;
          transform: rotate(45deg) scale(1.2);
        }
        100% {
          opacity: 0;
          transform: rotate(45deg) scale(0);
        }
      }
    </style>
  </head>
  <body>
      <div class="container">
        <div id="sparkle-container"></div>
        <div class="cat-wrapper">
          <img class="cat-img" src="kali.png" alt="Magic Cat" />
          <svg
            id="mystic-board"
            class="board"
            role="img"
            aria-label="Mystic chord diagram"
          ></svg>
        </div>
        <h2>SuperLotto Plus Picker</h2>
        <p id="instructions"></p>
        <div class="button-row">
          <button id="pick-btn" class="button">Generate Numbers</button>
          <button id="store-btn" class="button" disabled>Store Pick</button>
          <button id="history-btn" class="button secondary">View Recent Picks</button>
        </div>
        <div id="numbers" class="numbers"></div>
      </div>
    <script>
      const MAIN_COUNT = 5;
      const MAIN_MAX = 47;
      const MEGA_MAX = 27;
      const STORE_API_URL = "https://d2zi62cpjup4kp.cloudfront.net/api/entries";
      let lastMain = [];
      let lastMega = null;
      const instructionsEl = document.getElementById("instructions");
      const pickBtn = document.getElementById("pick-btn");
      const historyBtn = document.getElementById("history-btn");
      const storeBtn = document.getElementById("store-btn");
      const numbersDiv = document.getElementById("numbers");
      const catImg = document.querySelector(".cat-img");
      const board = document.getElementById("mystic-board");
      instructionsEl.innerHTML = `Pick <strong>${MAIN_COUNT} numbers</strong> between 1 and ${MAIN_MAX} and <strong>1 Mega number</strong> between 1 and ${MEGA_MAX}.`;
      async function fetchWithTimeout(resource, options = {}, timeoutMs = 10000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeoutMs);
        try {
          const response = await fetch(resource, {
            ...options,
            signal: controller.signal,
            mode: "cors",
            cache: "no-store",
            credentials: "omit",
          });
          return response;
        } finally {
          clearTimeout(id);
        }
      }
      function randIntInclusive(min, max) {
        const range = max - min + 1;
        const buf = new Uint32Array(1);
        let x;
        do {
          crypto.getRandomValues(buf);
          x = buf[0] % range;
        } while (buf[0] - x > 0xffffffff - (0xffffffff % range));
        return min + x;
      }
      function spawnSparkles(count = 8) {
        const container = document.getElementById("sparkle-container");
        for (let i = 0; i < count; i++) {
          const spark = document.createElement("div");
          spark.className = "sparkle";
          const size = Math.random() * 8 + 4;
          spark.style.width = size + "px";
          spark.style.height = size + "px";
          spark.style.left = Math.random() * 100 + "%";
          spark.style.top = Math.random() * 100 + "%";
          container.appendChild(spark);
          setTimeout(() => {
            if (spark.parentElement) spark.parentElement.removeChild(spark);
          }, 1500);
        }
      }
      function generateNumbers() {
        pickBtn.disabled = true;
        storeBtn.disabled = true;
        storeBtn.textContent = "Store Pick";
        numbersDiv.innerHTML = "";
        catImg.style.animation = "spin 1.5s linear";
        let iteration = 0;
        const sparkleInterval = setInterval(() => {
          spawnSparkles(5);
        }, 150);
        const interval = setInterval(() => {
          const unique = new Set();
          while (unique.size < MAIN_COUNT) {
            unique.add(randIntInclusive(1, MAIN_MAX));
          }
          const arr = Array.from(unique).sort((a, b) => a - b);
          const mega = randIntInclusive(1, MEGA_MAX);
          numbersDiv.innerHTML = "";
          arr.forEach((n) => {
            const ball = document.createElement("div");
            ball.className = "number-ball";
            ball.textContent = n;
            numbersDiv.appendChild(ball);
          });
          const megaBall = document.createElement("div");
          megaBall.className = "number-ball mega-ball";
          megaBall.textContent = mega;
          numbersDiv.appendChild(megaBall);
          lastMain = arr;
          lastMega = mega;
          mystic.draw(MAIN_MAX, arr);
          if (iteration === 0) board.style.display = "block";
          iteration++;
          if (iteration >= 20) {
            clearInterval(interval);
            clearInterval(sparkleInterval);
            pickBtn.disabled = false;
            storeBtn.disabled = false;
            catImg.style.animation = "";
          }
        }, 100);
      }
      async function storePick() {
        if (!lastMain.length || lastMega === null) {
          alert("Generate a pick before storing it.");
          return;
        }
        const originalText = storeBtn.textContent;
        storeBtn.disabled = true;
        storeBtn.textContent = "Savingâ€¦";

        const picks = lastMain.map((number) => ({ Number: number, IsSpecial: false, Name: null }));
        picks.push({ Number: lastMega, IsSpecial: true, Name: null });
        const payload = { picks, pickedAt: new Date().toISOString() };

        // Attempt 1: standard JSON POST
        try {
          const resp = await fetchWithTimeout(STORE_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json", Accept: "application/json" },
            body: JSON.stringify(payload),
          }, 12000);

          if (!resp.ok) {
            const text = await resp.text().catch(() => "");
            console.error("StorePick failed:", { status: resp.status, statusText: resp.statusText, body: text });
            // If it's a typical unsupported preflight scenario, try a fallback below
            if (resp.status === 415 || resp.status === 400) throw new Error("Server rejected JSON; trying fallback");
            throw new Error(`Request failed with status ${resp.status}`);
          }

          // Success
          window.location.href = "history.html";
          return;
        } catch (err) {
          console.warn("First attempt to store pick failed:", err);
        }

        // Attempt 2 (fallback): text/plain without Content-Type json to avoid preflight
        try {
          const resp2 = await fetchWithTimeout(STORE_API_URL, {
            method: "POST",
            // Intentionally omit Content-Type to keep it CORS-safelisted (text/plain)
            headers: { Accept: "application/json" },
            body: JSON.stringify(payload),
          }, 12000);

          if (!resp2.ok) {
            const text2 = await resp2.text().catch(() => "");
            console.error("StorePick fallback failed:", { status: resp2.status, statusText: resp2.statusText, body: text2 });
            throw new Error(`Fallback failed with status ${resp2.status}`);
          }

          // Success via fallback
          window.location.href = "history.html";
          return;
        } catch (finalErr) {
          console.error("Unable to store pick after fallback:", finalErr);
          alert("Unable to store your pick right now. This may be a CORS or network configuration issue. Please try again later.");
          storeBtn.disabled = false;
          storeBtn.textContent = originalText;
        }
      }
      pickBtn.addEventListener("click", generateNumbers);
      historyBtn.addEventListener("click", () => { window.location.href = "history.html"; });
      storeBtn.addEventListener("click", storePick);

      const mystic = (() => {
        const svg = d3.select("#mystic-board");
        const g = svg.append("g");
        const defs = svg.append("defs");

        const glow = defs.append("filter").attr("id", "glow");
        glow
          .append("feGaussianBlur")
          .attr("stdDeviation", 3)
          .attr("result", "coloredBlur");
        const feMerge = glow.append("feMerge");
        feMerge.append("feMergeNode").attr("in", "coloredBlur");
        feMerge.append("feMergeNode").attr("in", "SourceGraphic");

        const grad = defs
          .append("linearGradient")
          .attr("id", "gradStroke")
          .attr("x1", "0%")
          .attr("y1", "0%")
          .attr("x2", "100%")
          .attr("y2", "0%");
        grad.append("stop").attr("offset", "0%").attr("stop-color", "#c9b5ff");
        grad.append("stop").attr("offset", "50%").attr("stop-color", "#a88bff");
        grad
          .append("stop")
          .attr("offset", "100%")
          .attr("stop-color", "#e0d7ff");

        function size() {
          const w = document.getElementById("mystic-board").clientWidth;
          svg.attr("viewBox", `0 0 ${w} ${w}`);
          g.attr("transform", `translate(${w / 2},${w / 2})`);
          return w;
        }

        function polarToXY(angle, r) {
          return [Math.cos(angle) * r, Math.sin(angle) * r];
        }

        function starOrder(k) {
          const step = Math.max(2, Math.floor(k / 2));
          const order = [];
          let i = 0;
          for (let n = 0; n < k; n++) {
            order.push(i);
            i = (i + step) % k;
          }
          return order;
        }

        function draw(totalPositions, picks) {
          const w = size();
          g.selectAll("*").remove();

          const R = w * 0.5;
          const rNode = Math.max(2, w * 0.006);

          g.append("circle")
            .attr("r", R)
            .attr("fill", "none")
            .attr("stroke", "#1a1c2a")
            .attr("stroke-width", 1.2);

          const toAngle = (n) =>
            ((n - 1) / totalPositions) * Math.PI * 2 - Math.PI / 2;
          const verts = picks
            .map((n) => ({ n, a: toAngle(n) }))
            .sort((a, b) => a.a - b.a);

          const order = starOrder(verts.length);

          const path = d3.path();
          const first = polarToXY(verts[order[0]].a, R);
          path.moveTo(first[0], first[1]);
          for (let i = 1; i < order.length; i++) {
            const p = polarToXY(verts[order[i]].a, R);
            path.lineTo(p[0], p[1]);
          }
          path.closePath();

          const chord = g
            .append("path")
            .attr("class", "chord")
            .attr("d", path.toString())
            .attr("fill", "none")
            .attr("stroke", "url(#gradStroke)")
            .attr("stroke-width", Math.max(1.5, w * 0.004))
            .attr("filter", "url(#glow)")
            .attr("stroke-linejoin", "round");

          const length = chord.node().getTotalLength();
          chord
            .attr("stroke-dasharray", length)
            .attr("stroke-dashoffset", length)
            .transition()
            .duration(1200)
            .ease(d3.easeCubicOut)
            .attr("stroke-dashoffset", 0);

          g.selectAll(".node")
            .data(verts)
            .enter()
            .append("circle")
            .attr("class", "node")
            .attr("cx", (d) => polarToXY(d.a, R)[0])
            .attr("cy", (d) => polarToXY(d.a, R)[1])
            .attr("r", rNode)
            .attr("fill", "#ffd8ff")
            .attr("opacity", 0.85)
            .attr("filter", "url(#glow)");
        }

        return { draw };
      })();

      window.addEventListener("resize", () => {
        if (lastMain.length) mystic.draw(MAIN_MAX, lastMain);
      });
    </script>
  </body>
</html>
